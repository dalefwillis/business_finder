# Ofelia scheduler configuration
# All times in container timezone (America/Chicago via TZ env var)
# Scraper image uses entrypoint.sh which loads .env and handles random delay
#
# IMPORTANT: Ofelia uses 6-field cron (sec min hour day month weekday)

# Daily digest at 8am - runs in the always-running listener container
[job-exec "digest"]
schedule = 0 0 8 * * *
container = business-finder-listener
command = python scripts/digest_pipeline.py --step send

# ============================================================================
# Weekly refresh jobs - Sundays at 5pm (before regular evening scrapes)
# Refreshes existing listings to detect status changes (sold, price changes)
# ============================================================================

# Microns refresh at 5pm Sunday
[job-run "refreshMicrons"]
schedule = 0 0 17 * * 0
image = business_finder-scraper-acquire
volume = /home/dale/Projects/business_finder/data:/app/data
volume = /home/dale/Projects/business_finder/.env:/app/.env:ro
command = python scripts/run_microns_scrape.py --refresh
delete = true

# Flippa refresh at 5:30pm Sunday
[job-run "refreshFlippa"]
schedule = 0 30 17 * * 0
image = business_finder-scraper-acquire
volume = /home/dale/Projects/business_finder/data:/app/data
volume = /home/dale/Projects/business_finder/.env:/app/.env:ro
command = python scripts/run_flippa_scrape.py --refresh
delete = true

# Acquire refresh at 6pm Sunday (requires login, do last)
[job-run "refreshAcquire"]
schedule = 0 0 18 * * 0
image = business_finder-scraper-acquire
volume = /home/dale/Projects/business_finder/data:/app/data
volume = /home/dale/Projects/business_finder/.env:/app/.env:ro
command = python scripts/run_acquire_scrape.py --refresh
delete = true

# ============================================================================
# Daily scrapes - evening before digest
# Entrypoint.sh adds 10-300s random delay automatically
# ============================================================================

# Microns at 7pm
[job-run "microns"]
schedule = 0 0 19 * * *
image = business_finder-scraper-acquire
volume = /home/dale/Projects/business_finder/data:/app/data
volume = /home/dale/Projects/business_finder/.env:/app/.env:ro
command = python scripts/run_microns_scrape.py
delete = true

# Flippa at 8pm
[job-run "flippa"]
schedule = 0 0 20 * * *
image = business_finder-scraper-acquire
volume = /home/dale/Projects/business_finder/data:/app/data
volume = /home/dale/Projects/business_finder/.env:/app/.env:ro
command = python scripts/run_flippa_scrape.py
delete = true

# Acquire at 9pm (requires login)
[job-run "acquire"]
schedule = 0 0 21 * * *
image = business_finder-scraper-acquire
volume = /home/dale/Projects/business_finder/data:/app/data
volume = /home/dale/Projects/business_finder/.env:/app/.env:ro
command = python scripts/run_acquire_scrape.py
delete = true
